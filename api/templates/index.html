<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physical AI RAG Chatbot</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f2f5; margin: 0; }
        .chat-container { width: 450px; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 30px rgba(0,0,0,0.15); background: white; }
        .chat-header { background-color: #007bff; color: white; padding: 15px 20px; text-align: center; font-size: 1.1em; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .header-btns { display: flex; gap: 8px; }
        .chat-box { height: 400px; overflow-y: auto; padding: 15px; background-color: #f8f9fa; display: flex; flex-direction: column; gap: 12px; }
        .message { padding: 12px 16px; border-radius: 18px; max-width: 85%; word-wrap: break-word; line-height: 1.4; font-size: 0.95em; }
        .user-message { background-color: #007bff; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .bot-message { background-color: white; border: 1px solid #dee2e6; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        .input-area { display: flex; padding: 15px; border-top: 1px solid #eee; background: white; align-items: center; gap: 8px; }
        input[type="text"] { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; transition: border 0.3s; }
        button { border: none; padding: 10px 18px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: opacity 0.2s; }
        #send-btn { background-color: #007bff; color: white; }
        .mic-btn { background: #e9ecef; color: #333; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; }
        .upload-btn { background-color: rgba(255,255,255,0.2); color: white; border: 1px solid white; font-size: 0.8em; padding: 6px 12px; }
        .clear-btn { background-color: transparent; color: #ffcccc; border: 1px solid #ffcccc; padding: 6px 12px; font-size: 0.8em; }
        button:hover { opacity: 0.8; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .spinner { display: none; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <span>ü§ñ Physical AI</span>
            <div class="header-btns">
                <button class="upload-btn" onclick="document.getElementById('file-input').click()">+ PDF</button>
                <button class="clear-btn" onclick="clearChat()">Clear</button>
            </div>
            <input type="file" id="file-input" style="display: none;" accept="application/pdf" onchange="uploadFile()">
        </div>

        <div class="chat-box" id="chat-box">
            <div class="message bot-message">Hello! Ask me anything about your textbook or upload a new PDF.</div>
        </div>

        <div class="input-area">
            <div id="loader" class="spinner"></div>
            <button class="mic-btn" onclick="startListening()" title="Speak your question">üéôÔ∏è</button>
            <input type="text" id="user-input" placeholder="Type your question here...">
            <button onclick="sendMessage()" id="send-btn">Send</button>
        </div>
    </div>

    <script>
        // 1. Voice Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;

        if (recognition) {
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('user-input').value = transcript;
                sendMessage(); // Auto-send after speaking
            };
            recognition.onend = () => {
                document.querySelector('.mic-btn').style.background = "#e9ecef";
            };
        }

        function startListening() {
            if (!recognition) {
                alert("Voice recognition not supported in this browser.");
                return;
            }
            document.querySelector('.mic-btn').style.background = "#ff4444";
            recognition.start();
        }

        // 2. Upload File Function
        async function uploadFile() {
            const fileInput = document.getElementById('file-input');
            const loader = document.getElementById('loader');
            if (!fileInput.files[0]) return;

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            loader.style.display = 'block';
            appendMessage(`‚è≥ Processing PDF: ${fileInput.files[0].name}...`, 'bot-message', false);

            try {
                const response = await fetch('/upload-pdf', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                appendMessage(`‚úÖ ${data.message}`, 'bot-message', false);
            } catch (error) {
                appendMessage("‚ùå Error: Upload failed.", 'bot-message', false);
            } finally {
                loader.style.display = 'none';
                fileInput.value = ''; 
            }
        }

        // 3. Send Message Function
        async function sendMessage() {
            const inputField = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const chatBox = document.getElementById('chat-box');
            const loader = document.getElementById('loader');
            const question = inputField.value.trim();

            if (question === "") return;

            appendMessage(question, 'user-message', false);
            inputField.value = '';
            sendBtn.disabled = true;
            loader.style.display = 'block';

            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                });

                const data = await response.json();
                
                if (response.ok) {
                    appendMessage(data.answer, 'bot-message', true);
                } else {
                    appendMessage("‚ö†Ô∏è Error: Could not get an answer.", 'bot-message', false);
                }
            } catch (error) {
                appendMessage("‚ùå Error connecting to server.", 'bot-message', false);
            } finally {
                sendBtn.disabled = false;
                loader.style.display = 'none';
            }
        }

        // 4. Helper Functions
        function appendMessage(text, className, isMarkdown) {
            const chatBox = document.getElementById('chat-box');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${className}`;
            
            if (isMarkdown) {
                msgDiv.innerHTML = marked.parse(text);
            } else {
                msgDiv.innerText = text;
            }
            
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return msgDiv;
        }

        function clearChat() {
            document.getElementById('chat-box').innerHTML = '<div class="message bot-message">Chat cleared. How can I help?</div>';
        }

        document.getElementById("user-input").addEventListener("keypress", function(event) {
            if (event.key === "Enter") { 
                event.preventDefault(); 
                document.getElementById("send-btn").click(); 
            }
        });
    </script>
</body>
</html>